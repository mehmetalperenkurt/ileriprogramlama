<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        <title>booking </title>
    </head>
<link rel="stylesheet" href="style.css">
<style>
    .main{
    background-position-x: center;
    background-position-y: center;
    }
</style>
    <body>
            <div class="main" style="align-content: center;margin-top: 5%; margin-left: 5%;"><h2 id=title>flight booking</h2>
                <br>
                <form action="">
                    one way<input type="radio" name="trip" checked id="radyo" onchange=""> 
        
                    
                </form>
                <br>
            <input type="text" id="departLocation" list="departLocationList" data-maxitems="5" placeholder="From" style="width:120px" autocomplete=on required role="combobox" aria-label="Flight origin input" smarty="true" autocomplete="off" autocapitalize="off" autocorrect="off" role="combobox" aria-autocomplete="departLocation" aria-expanded="true">
                <datalist id="departLocationList">
                </datalist>
            <input type="button" value="<->" onclick="tooglesw()">
            <input type="text" id="destinationLocationId" data-maxitems="5" list="destinationLocationList" placeholder="To" autocomplete="on" style="width: 120px" autocomplete=off required>
                <datalist id="destinationLocationList">
                </datalist>

        <input type="date" id="depart" name="trip-start" max="2019-12-12">
        
        <input type="button" onclick="getFlightHours();" value="search"><br>
		adults<input id="txtAdultCount" type="number" step="1" value="1" min="1" max="5">
        childs<input id="txtChildCount" type="number" step="1" value="0" min="0" max="3" placeholder="0">
		<div id="div-customer" style="display:none;" class="main">
        
            
        </div>
		<div id="result-flight" style="display:none;" class="main">
            
        </div>
        <input id="hiddenHour" type="hidden" value="">
        <input id="txtDepartDate" type="hidden" value="">
        <input id="hiddenAdultCount" type="hidden" value="">
        <input id="hiddenChildCount" type="hidden" value="">
        <input id="hiddenFlightCode" type="hidden" value="">

        
        <input id="txtSeatNumber" type="hidden" value="">
        
        
    </div>
        
        
    <br>
    <p id=out></p>
    <div class="plane">
  <div class="cockpit">
  </div>
  <ol class="cabin fuselage">
  
    <li class="row row--1">
      <ol class="seats" type="A">
        <li class="seat">
          <input type="checkbox" id="1A" />
          <label for="1A">1A</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="1B" />
          <label for="1B">1B</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="1C" />
          <label for="1C">1C</label>
        </li>
        <li class="seat">
          <input type="checkbox"  id="1D" />
          <label for="1D">1D</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="1E" />
          <label for="1E">1E</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="1F" />
          <label for="1F">1F</label>
        </li>
      </ol>
    </li>
    <li class="row row--2">
      <ol class="seats" type="A">
        <li class="seat">
          <input type="checkbox" id="2A" />
          <label for="2A">2A</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="2B" />
          <label for="2B">2B</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="2C" />
          <label for="2C">2C</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="2D" />
          <label for="2D">2D</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="2E" />
          <label for="2E">2E</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="2F" />
          <label for="2F">2F</label>
        </li>
      </ol>
    </li>
    <li class="row row--3">
      <ol class="seats" type="A">
        <li class="seat">
          <input type="checkbox" id="3A" />
          <label for="3A">3A</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="3B" />
          <label for="3B">3B</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="3C" />
          <label for="3C">3C</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="3D" />
          <label for="3D">3D</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="3E" />
          <label for="3E">3E</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="3F" />
          <label for="3F">3F</label>
        </li>
      </ol>
    </li>
    <li class="row row--4">
      <ol class="seats" type="A">
        <li class="seat">
          <input type="checkbox" id="4A" />
          <label for="4A">4A</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="4B" />
          <label for="4B">4B</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="4C" />
          <label for="4C">4C</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="4D" />
          <label for="4D">4D</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="4E" />
          <label for="4E">4E</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="4F" />
          <label for="4F">4F</label>
        </li>
      </ol>
    </li>
    <li class="row row--5">
      <ol class="seats" type="A">
        <li class="seat">
          <input type="checkbox" id="5A" />
          <label for="5A">5A</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="5B" />
          <label for="5B">5B</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="5C" />
          <label for="5C">5C</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="5D" />
          <label for="5D">5D</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="5E" />
          <label for="5E">5E</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="5F" />
          <label for="5F">5F</label>
        </li>
      </ol>
    </li>
    <li class="row row--6">
      <ol class="seats" type="A">
        <li class="seat">
          <input type="checkbox" id="6A" />
          <label for="6A">6A</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="6B" />
          <label for="6B">6B</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="6C" />
          <label for="6C">6C</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="6D" />
          <label for="6D">6D</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="6E" />
          <label for="6E">6E</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="6F" />
          <label for="6F">6F</label>
        </li>
      </ol>
    </li>
    <li class="row row--7">
      <ol class="seats" type="A">
        <li class="seat">
          <input type="checkbox" id="7A" />
          <label for="7A">7A</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="7B" />
          <label for="7B">7B</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="7C" />
          <label for="7C">7C</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="7D" />
          <label for="7D">7D</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="7E" />
          <label for="7E">7E</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="7F" />
          <label for="7F">7F</label>
        </li>
      </ol>
    </li>
    <li class="row row--8">
      <ol class="seats" type="A">
        <li class="seat">
          <input type="checkbox" id="8A" />
          <label for="8A">8A</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="8B" />
          <label for="8B">8B</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="8C" />
          <label for="8C">8C</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="8D" />
          <label for="8D">8D</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="8E" />
          <label for="8E">8E</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="8F" />
          <label for="8F">8F</label>
        </li>
      </ol>
    </li>
    <li class="row row--9">
      <ol class="seats" type="A">
        <li class="seat">
          <input type="checkbox" id="9A" />
          <label for="9A">9A</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="9B" />
          <label for="9B">9B</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="9C" />
          <label for="9C">9C</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="9D" />
          <label for="9D">9D</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="9E" />
          <label for="9E">9E</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="9F" />
          <label for="9F">9F</label>
        </li>
      </ol>
    </li>
    <li class="row row--10">
      <ol class="seats" type="A">
        <li class="seat">
          <input type="checkbox" id="10A" />
          <label for="10A">10A</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="10B" />
          <label for="10B">10B</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="10C" />
          <label for="10C">10C</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="10D" />
          <label for="10D">10D</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="10E" />
          <label for="10E">10E</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="10F" />
          <label for="10F">10F</label>
        </li>
      </ol>
    </li>
        <li class="row row--11">
      <ol class="seats" type="A">
        <li class="seat">
          <input type="checkbox" id="11A" />
          <label for="11A">11A</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="11B" />
          <label for="11B">11B</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="11C" />
          <label for="11C">11C</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="11D" />
          <label for="11D">11D</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="11E" />
          <label for="11E">11E</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="11F" />
          <label for="11F">11F</label>
        </li>
      </ol>
    </li>
        <li class="row row--12">
      <ol class="seats" type="A">
        <li class="seat">
          <input type="checkbox" id="12A" />
          <label for="12A">12A</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="12B" />
          <label for="12B">12B</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="12C" />
          <label for="12C">12C</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="12D" />
          <label for="12D">12D</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="12E" />
          <label for="12E">12E</label>
        </li>
        <li class="seat">
          <input type="checkbox" id="12F" />
          <label for="12F">12F</label>
        </li>
      </ol>
    </li>
  </ol>
  
</div>
    </body>

<script>
function tooglesw(){
    
    var c=document.getElementById('departLocation').value;
    var d=document.getElementById('destinationLocationId').value;
    document.getElementById('departLocation').value=d;
    document.getElementById('destinationLocationId').value=c;
    
}
 /*<template id="resultstemplate">    </template>
 var search = document.querySelector('#departLocation');
    var results = document.querySelector('#departLocationList');
    var templateContent = document.querySelector('#resultstemplate').content;
    search.addEventListener('keyup', function handler(event) {
    while (results.children.length) results.removeChild(results.firstChild);
    var inputVal = new RegExp(search.value.trim(), 'i');
    var clonedOptions = templateContent.cloneNode(true);
    var set = Array.prototype.reduce.call(clonedOptions.children, function searchFilter(frag, el) {
        if (inputVal.test(el.textContent) && frag.children.length < 4) frag.appendChild(el);
        return frag;
    }, document.createDocumentFragment());
    results.appendChild(set);
});*/ 
var today = new Date();
var dd = today.getDate();
var mm = today.getMonth()+1; //ocak=0
var yyyy = today.getFullYear();
 if(dd<10){
        dd='0'+dd
    } 
    if(mm<10){
        mm='0'+mm
    } 
today = yyyy+'-'+mm+'-'+dd;
document.getElementById("depart").setAttribute("min", today);
//document.getElementById("depart2").setAttribute("min", today);
document.getElementById('depart').value = today;
class Flights{
constructor(companyName,flightCode,aircraftModel,departLocation,departLocationCode,destinationLocation,destinationLocationCode,flightDates){
        this.companyName=companyName
        this.flightCode=flightCode
        this.aircraftModel=aircraftModel
        this.departLocation=departLocationCode
        this.departLocationCode=departLocation
        this.destinationLocation=destinationLocation 
        this.destinationLocationCode=destinationLocationCode
        this.flightDates=flightDates
    }
}
class aircraft{
    constructor(){
        this.schema="";
        this.model="";
        this.capacity="";
        this.seats="";
    }
}
class company{
    constructor(){
        this.name="";
        this.fleet="";
        this.logoURL="";
    }
}
class airport{
    constructor(){
        this.airportCode="";
        this.cityName="";
        this.countryName="";
        //this.countryCode="";
        this.gates="";
        //this.flightList="";
    }
}
class passenger{
    constructor(name, guid){
        this.name=name;
        this.guid = guid;
    }
}
class ticket{
    constructor(guid,resCode,seats,date,boardingTime, passenger){
        this.guid=guid;
        this.resCode=resCode;
        this.seats=seats;
        this.date=date;
        this.boardingTime=boardingTime;
        this.passenger = passenger;
    }
}
class database{
    constructor(){
        this.urlS="https://mehmetalperenkurt.github.io/ileriprogramlama/work/calisma/flights2.txt";
        this.flights= new Map();
        this.tickets=new Map();
        this.airports=new Set();
        this.readFlights();
    }
    readFlights(){
        console.log("readFlights "+this.urlS);
        fetch(this.urlS)
        .then(r => r.text())
        .then(r => this.addFlights(r))
    }
    addFlights(txt){
        let a = txt.split("\n");
        for (let s of a) {
        let flights = this.parseFlights(s);
        this.flights.set(flights.flightCode,flights);
        }
    }
    parseFlights(line){
        let s = line.split("\t");
        let dates = [];
        let e=[];
        for (let i=7; i<s.length; i++) 
        dates.push(s[i]);
        const flight = new Flights(s[0],s[1],s[2],s[3],s[4],s[5],s[6],dates);
        let c=s[4]+" "+s[3]
        this.airports.add(c)
        return flight
    }
     datalist(){
        let arr=Array.from(ac.airports);
        var list='';
        for(var i = 0; i < arr.length; i++)
        list += '<option value="'+arr[i]+'" />';
        document.getElementById('departLocationList').innerHTML = list;
        document.getElementById('destinationLocationList').innerHTML=list;
    }
    sellTicket(){
	var adultCnt=parseInt(document.getElementById('hiddenAdultCount').value);
    var childCnt=parseInt(document.getElementById('hiddenChildCount').value);
	var customerNameCnt=[];
	var countCnt=adultCnt+childCnt;
	for(let i=0;i<countCnt;i++){
	var j=document.getElementsByClassName('fname')[i].value;
	if(j!="") customerNameCnt.push(j);
	}
	//if(customerNameCnt==""||customerNameCnt==null) alert("Please fill all required fields")
	if(customerNameCnt.length!=countCnt||customerNameCnt==null) alert("Please fill all required fields")
	else{
    var seatTextList = document.getElementById('txtSeatNumber').value.split(',');
    var currentHour = document.getElementById('hiddenHour').value;
    var currentDate = document.getElementById('txtDepartDate').value;
    var flightCode = document.getElementById('hiddenFlightCode').value;
    for(var i=0; i< seatTextList.length; i++){
        var currentSeat = seatTextList[i];
        var currentCustomer = document.getElementById('customer'+(i+1)).value;
        var ticketCode= currentDate+" "+currentHour+" "+flightCode + " " + currentSeat;
        var ticketGuid = guid();
        const ticket11 =new ticket(ticketGuid,flightCode,currentSeat,currentDate,currentHour, currentCustomer);
        ac.tickets.set(ticketCode, ticket11);
    }
    document.getElementById("div-customer").style.display = "none";}
}
}
ac=new database();
function getFlightHours(){
    document.getElementById('div-customer').setAttribute("style","display:none;");
	var departure =  document.getElementById('departLocation').value.split(' ')[0];
    var destination = document.getElementById('destinationLocationId').value.split(' ')[0];
    
    var departDate = document.getElementById('depart').value;
    var adultCount = document.getElementById('txtAdultCount').value;
    var childCount = document.getElementById('txtChildCount').value;
    document.getElementById('txtDepartDate').value = departDate;
    document.getElementById('hiddenAdultCount').value = adultCount;
    document.getElementById('hiddenChildCount').value = childCount;
    var flightDates = [];
    for(let x of ac.flights){
        var item = x[1];
        if(item.departLocation == departure && item.destinationLocationCode == destination){
            
            flightDates = item.flightDates;
            appendToLi(flightDates, item.flightCode);
        }
    }
    if(flightDates.length<1){
        return alert("Uygun Bir Uçuş Mevcut Değildir");
    }
}
var appendToLi = function(flightDates, flightCode){
    var $html = "";
    $html += "<ul>";
    flightDates.forEach(element => {
        
        $html += "<li><a onclick='setTicket(this)' flightCode='"+flightCode+"'>"+element+"</a></li>";
    });
    $html+= "</ul>";
    document.getElementById("result-flight").style.display = "block";
    document.getElementById("result-flight").innerHTML = "";
    document.getElementById("result-flight").innerHTML = $html;
}
/*var arrayRemove = function(arr,value){
   return arr.filter(function(ele){
       return ele != value;
   });
}*/
var setTicket = function(e){
    
    var availableList = [];
    var hour = e.innerText;
    document.getElementById('hiddenHour').value = hour;
     
    var flightCode = e.getAttribute('flightCode');
    document.getElementById('hiddenFlightCode').value = flightCode;
    var departDate = document.getElementById('txtDepartDate').value;
    var adultCount = document.getElementById('hiddenAdultCount').value;
    var childCount = document.getElementById('hiddenChildCount').value;
    
    var seatCount = parseInt(adultCount) + parseInt(childCount);
    var ticketCode=departDate+" "+hour+" "+flightCode;
    var allSeatList = getPlaneSeat(); // Her durumda !!!!!!
    var busySeat = hasKey(ticketCode);
    if(busySeat.length > 0)
        availableList = getAvailableSeat(busySeat,allSeatList);
    else
        availableList = allSeatList;
    if(availableList.length < 1){
        
        //document.getElementById('txtSeatNumber').value = seatTextList;
        return console.log("Boş Koltuk Yok");
        }
    else
    {
        var seatTextList = getSeatByCount(availableList, seatCount);
        document.getElementById('txtSeatNumber').value = seatTextList;
        generateCustomerForm(seatCount);
    }
// for(let x of ac.flights){
//     var item =x[1];
//     item.flightCode
//     document.getElementById('depart').value;
// }
}
var hasKey = function(ticketCode){
    var busySeat = [];
    for(let x of ac.tickets){
        var currentTicketList = x[0].split(" ");
        var currentTicketText = currentTicketList[0] + " " + currentTicketList[1] + " " + currentTicketList[2];
        if(currentTicketText == ticketCode){
            busySeat.push(x[1].seats);
        }
    }
    return busySeat;
}
var generateCustomerForm = function(seatCount){
    var $html = "";
    for(var i=0; i< seatCount; i++){
        var count = i+1;
        var $inputHtml = 'Passenger '+count+': <input id="customer'+count+'" type="text" name="fname" class="fname" required><br>';
        $html += $inputHtml;
    }
    var $btn = "<button onclick='ac.sellTicket();'>Buy Ticket</button>";
    $html += $btn;
    document.getElementById("div-customer").style.display = "block";
    document.getElementById("div-customer").innerHTML = "";
    document.getElementById("div-customer").innerHTML = $html;
    document.getElementById("result-flight").style.display = "none";
    
}
var getSeatByCount = function(availableList, seatCount){
    var seatTextList = "";
    for(var i=0; i<seatCount; i++){
        if(i == 0)
            seatTextList += availableList[i];
        else
            seatTextList += "," + availableList[i];
    }
    return seatTextList;
}
var getAvailableSeat = function(busySeat,allSeatList){
    //var availableList = [];
    for(let x of busySeat){
        for(let y of allSeatList){
            if(x == y)
            {
                //arrayRemove(allSeatList,x);
                //allSeatList.remove(x);
                var item1 = allSeatList.indexOf(x);
                allSeatList.splice(item1,1);
            }
        }
    }
    return allSeatList;
}
// koltuk seçtirme
var getPlaneSeat = function(){
    var list = [];
    var $html = "";
    for(var i=0; i<12; i++){
        var seatNumber = i+1;
        //$html += "<div>";
        for(var j=0; j<6; j++){
            var seatLetter = generateLetter(j+1);
            list.push(seatLetter + seatNumber);
            //$html += "<button letter="+seatLetter+">"+ seatNumber +"</button>";
        }
        //$html +="</div><br />";
    }
    return list;
}
var generateLetter = function(value){
    var letter = "";
    switch(value) {
        case 1:
        letter = "A";
        break;
        case 2:
        letter = "B";
        break;
        case 3:
        letter = "C";
        break;
        case 4:
        letter = "D";
        break;
        case 5:
        letter = "E";
        break;
        case 6:
        letter = "F";
        break;
    }
    return letter;
}
var showSeat=function(){
var item=[];
var control1=document.getElementById('hiddenHour').value;
var control2=document.getElementById('txtDepartDate').value;
var control3=document.getElementById('hiddenFlightCode').value;
for(let x of ac.tickets){
    
    var item1=x[0].split(" ");
        if(control2==item1[0]&&control1==item1[1]&&control3==item1[2]){
console.log(item1[3]);}
}
}
function guid() {
  function s4() {
    return Math.floor((1 + Math.random()) * 0x10000)
      .toString(16)
      .substring(1);
  }
  return s4() + s4() + '-' + s4() + '-' + s4() + '-' + s4() + '-' + s4() + s4() + s4();
}
//  setTimeout(ac.datalist(),2500);
/*function datalist(){
for (let a of ac.airports){
var str='';
str += '<option value="'+a+'" />';
}
var list=document.getElementById("departLocationList");
list.innerHTML =+str;
departLocationList.innerHTML=str;
}*/
</script>
</html>
<script>
setTimeout(function(){ const out=ac.flights.size; document.getElementById('out').innerHTML=+""+out+" flights found."; ac.datalist(); }, 1500);
</script>